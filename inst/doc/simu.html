<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Wei Liu" />

<meta name="date" content="2025-03-27" />

<title>SpaCOAP: simulation</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SpaCOAP: simulation</h1>
<h4 class="author">Wei Liu</h4>
<h4 class="date">2025-03-27</h4>



<p>This vignette introduces the usage of SpaCOAP for the analysis of
high-dimensional count data with additional high-dimensional covariates,
by comparison with other methods.</p>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(SpaCOAP)</span></code></pre></div>
<div id="generate-the-simulated-data" class="section level2">
<h2>Generate the simulated data</h2>
<p>First, we generate the data simulated data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>width <span class="ot">&lt;-</span> <span class="dv">20</span>; height <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> width<span class="sc">*</span>height</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>p<span class="ot">=</span><span class="dv">500</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>q <span class="ot">=</span> <span class="dv">5</span>; d <span class="ot">&lt;-</span> <span class="dv">40</span>; k <span class="ot">&lt;-</span> <span class="dv">3</span>; r <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>bandwidth <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>rho<span class="ot">&lt;-</span>   <span class="fu">c</span>(<span class="dv">8</span>,<span class="fl">0.6</span>) </span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>sigma2_eps<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>datlist <span class="ot">&lt;-</span> <span class="fu">gendata_spacoap</span>(<span class="at">seed=</span><span class="dv">1</span>, <span class="at">width=</span>width, <span class="at">height =</span> height,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                           <span class="at">p=</span>p, <span class="at">q=</span>q, <span class="at">d=</span>d, <span class="at">k=</span>k, <span class="at">rank0 =</span> r, <span class="at">bandwidth=</span><span class="dv">1</span>,</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>                           <span class="at">eta0 =</span> <span class="fl">0.5</span>, <span class="at">rho=</span>rho, <span class="at">sigma2_eps=</span>sigma2_eps)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>X_count <span class="ot">&lt;-</span> datlist<span class="sc">$</span>X; H <span class="ot">&lt;-</span> datlist<span class="sc">$</span>H; Z <span class="ot">&lt;-</span> datlist<span class="sc">$</span>Z</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>F0 <span class="ot">&lt;-</span> datlist<span class="sc">$</span>F0; B0 <span class="ot">&lt;-</span> datlist<span class="sc">$</span>B0</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>bbeta0 <span class="ot">&lt;-</span> datlist<span class="sc">$</span>bbeta0; alpha0 <span class="ot">&lt;-</span> datlist<span class="sc">$</span>alpha0</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>Adj_sp <span class="ot">&lt;-</span> SpaCOAP<span class="sc">:::</span><span class="fu">getneighbor_weightmat</span>(datlist<span class="sc">$</span>pos, <span class="fl">1.1</span>,  bandwidth)</span></code></pre></div>
<p>Fit the SpaCOAP model using the function <code>SpaCOAP()</code> in
the R package <code>SpaCOAP</code>. Users can use <code>?SpaCOAP</code>
to see the details about this function.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>reslist <span class="ot">&lt;-</span> <span class="fu">SpaCOAP</span>(X_count,Adj_sp, H, <span class="at">Z =</span> Z, <span class="at">rank_use =</span> r, <span class="at">q=</span>q)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">str</span>(reslist)</span></code></pre></div>
<p>Check the increased property of the envidence lower bound
function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>dat_iter <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">iter=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(reslist<span class="sc">$</span>ELBO_seq[<span class="sc">-</span><span class="dv">1</span>]), <span class="at">ELBO=</span>reslist<span class="sc">$</span>ELBO_seq[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>dat_iter, <span class="fu">aes</span>(<span class="at">x=</span>iter, <span class="at">y=</span>ELBO)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span></code></pre></div>
<p>We calculate the metrics to measure the estimatioin accuracy, where
the trace statistic is used to measure the estimation accuracy of
loading matrix and prediction accuracy of factor matrix, and the mean
absolute error is adopted to measure the estimation error of bbeta and
alpha.</p>
<p>First, we define the metric functions:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>norm1_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">abs</span>(x))</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>trace_statistic_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(H, H0){</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  </span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  tr_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">diag</span>(x))</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  mat1 <span class="ot">&lt;-</span> <span class="fu">t</span>(H0) <span class="sc">%*%</span> H <span class="sc">%*%</span> <span class="fu">qr.solve</span>(<span class="fu">t</span>(H) <span class="sc">%*%</span> H) <span class="sc">%*%</span> <span class="fu">t</span>(H) <span class="sc">%*%</span> H0</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  </span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="fu">tr_fun</span>(mat1) <span class="sc">/</span> <span class="fu">tr_fun</span>(<span class="fu">t</span>(H0) <span class="sc">%*%</span> H0)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, we calculate the quantities for SpaCOAP.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>metricList <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP<span class="sc">$</span>F_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(reslist<span class="sc">$</span>F, F0)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP<span class="sc">$</span>B_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(reslist<span class="sc">$</span>B, B0)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP<span class="sc">$</span>alpha_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(reslist<span class="sc">$</span>alpha<span class="sc">-</span> alpha0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(alpha0))  </span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP<span class="sc">$</span>beta_norm1<span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(reslist<span class="sc">$</span>bbeta<span class="sc">-</span> bbeta0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(bbeta0))</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>metricList<span class="sc">$</span>SpaCOAP<span class="sc">$</span>time <span class="ot">&lt;-</span> reslist<span class="sc">$</span>time_use</span></code></pre></div>
</div>
<div id="compare-with-other-methods" class="section level2">
<h2>Compare with other methods</h2>
<p>We compare SpaCOAP with various prominent methods in the literature.
(1) COAP performs covariate-argumented Poisson factor model with the
consideration of the low-rank structure of the coefficient matrix, but
falls short in accounting for the spatial dependence among units, which
is implemented in the R package <strong>COAP</strong>; (2) PLNPCA
performs covariate-argumented PCA without considering the low-rank
structure of the coefficient matrix and spatial dependence among units,
which is implemented in the R package <strong>PLNmodels</strong>; (3)
Multi-response reduced-rank Poisson regression model (MRRR) performs the
estimation of low-rank coefficient matrix and factor part by treating
them as a single entity, and fails to account for spatial dependence
among units, which is implemented in <strong>rrpack</strong> R package.
(4) Spatial Poisson factor model, called FAST, takes into account
spatial dependence among units, but unable to account for additional
covariates, which is implemented in the R package
<strong>ProFAST</strong>.</p>
<p>First, we implement COAP method:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(COAP)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>res_coap <span class="ot">&lt;-</span> <span class="fu">RR_COAP</span>(X_count, <span class="at">Z =</span> <span class="fu">cbind</span>(Z, H), <span class="at">rank_use=</span> k<span class="sc">+</span>r, <span class="at">q=</span><span class="dv">5</span>, <span class="at">epsELBO =</span> <span class="fl">1e-9</span>)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>time_coap <span class="ot">&lt;-</span> toc[<span class="dv">3</span>] <span class="sc">-</span> tic[<span class="dv">3</span>]</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>metricList<span class="sc">$</span>COAP<span class="sc">$</span>F_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_coap<span class="sc">$</span>H, F0)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>metricList<span class="sc">$</span>COAP<span class="sc">$</span>B_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_coap<span class="sc">$</span>B, B0)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>alpha_coap <span class="ot">&lt;-</span> res_coap<span class="sc">$</span>bbeta[,<span class="dv">1</span><span class="sc">:</span>k]</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>beta_coap <span class="ot">&lt;-</span> res_coap<span class="sc">$</span>bbeta[,(k<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(k<span class="sc">+</span>d)]</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>metricList<span class="sc">$</span>COAP<span class="sc">$</span>alpha_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(alpha_coap<span class="sc">-</span> alpha0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(alpha0))</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>metricList<span class="sc">$</span>COAP<span class="sc">$</span>beta_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(beta_coap<span class="sc">-</span> bbeta0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(bbeta0))</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>metricList<span class="sc">$</span>COAP<span class="sc">$</span>time <span class="ot">&lt;-</span> time_coap</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Secondly, we implemented the PLNPCA and record the metrics that
measure the estimation accuracy and computational cost.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>PLNPCA_run <span class="ot">&lt;-</span> <span class="cf">function</span>(X_count, covariates, q,  <span class="at">Offset=</span><span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(X_count)), <span class="at">workers=</span><span class="cn">NULL</span>,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                       <span class="at">maxIter=</span><span class="dv">10000</span>,<span class="at">ftol_rel=</span><span class="fl">1e-8</span>, <span class="at">xtol_rel=</span> <span class="fl">1e-4</span>){</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="fu">require</span>(PLNmodels)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(workers)){</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> workers)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  }</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.character</span>(Offset)){</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    dat_plnpca <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(X_count, covariates)</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    dat_plnpca<span class="sc">$</span>Offset <span class="ot">&lt;-</span> Offset</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    dat_plnpca <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(X_count, covariates, <span class="at">offset =</span> Offset)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  }</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(covariates)</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>  <span class="co">#  offset(log(Offset))+</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>  formu <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;Abundance ~ 1 + offset(log(Offset))+&quot;</span>,<span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="st">&quot;V&quot;</span>,<span class="dv">1</span><span class="sc">:</span>d), <span class="at">collapse =</span> <span class="st">&#39;+&#39;</span>))</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>  control_use  <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxeval=</span>maxIter, <span class="at">ftol_rel=</span>ftol_rel, <span class="at">xtol_rel=</span> ftol_rel)</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>  control_main <span class="ot">&lt;-</span> <span class="fu">PLNPCA_param</span>(</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>    <span class="at">backend =</span> <span class="st">&quot;nlopt&quot;</span>,</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>    <span class="at">trace =</span> <span class="dv">1</span>,</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>    <span class="at">config_optim =</span> control_use,</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="at">inception =</span> <span class="cn">NULL</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>  )</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>  </span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>  myPCA <span class="ot">&lt;-</span> <span class="fu">PLNPCA</span>(<span class="fu">as.formula</span>(formu), <span class="at">data =</span> dat_plnpca, <span class="at">ranks =</span> q,  <span class="at">control =</span> control_main)</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>  </span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>  myPCA1 <span class="ot">&lt;-</span> <span class="fu">getBestModel</span>(myPCA)</span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>  myPCA1<span class="sc">$</span>scores</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>  </span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>  res_plnpca <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">PCs=</span> myPCA1<span class="sc">$</span>scores, <span class="at">bbeta=</span> myPCA1<span class="sc">$</span>model_par<span class="sc">$</span>B, </span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>                     <span class="at">loadings=</span>myPCA1<span class="sc">$</span>model_par<span class="sc">$</span>C)</span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>  </span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>  <span class="fu">return</span>(res_plnpca)</span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>}</span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>res_plnpca <span class="ot">&lt;-</span> <span class="fu">PLNPCA_run</span>(X_count, <span class="fu">cbind</span>(Z[,<span class="sc">-</span><span class="dv">1</span>],H), <span class="at">q=</span>q)</span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>time_plnpca <span class="ot">&lt;-</span> toc[<span class="dv">3</span>] <span class="sc">-</span> tic[<span class="dv">3</span>]</span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>  </span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>metricList<span class="sc">$</span>PLNPCA<span class="sc">$</span>F_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_plnpca<span class="sc">$</span>PCs, F0)</span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>metricList<span class="sc">$</span>PLNPCA<span class="sc">$</span>B_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_plnpca<span class="sc">$</span>loadings, B0)</span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>alpha_plnpca <span class="ot">&lt;-</span> <span class="fu">t</span>(res_plnpca<span class="sc">$</span>bbeta[<span class="dv">1</span><span class="sc">:</span>k,])</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>beta_plnpca <span class="ot">&lt;-</span> <span class="fu">t</span>(res_plnpca<span class="sc">$</span>bbeta[(k<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(k<span class="sc">+</span>d),])</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>metricList<span class="sc">$</span>PLNPCA<span class="sc">$</span>alpha_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(alpha_plnpca<span class="sc">-</span> alpha0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(alpha0))</span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>metricList<span class="sc">$</span>PLNPCA<span class="sc">$</span>beta_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(beta_plnpca<span class="sc">-</span> bbeta0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(bbeta0))</span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>metricList<span class="sc">$</span>PLNPCA<span class="sc">$</span>time <span class="ot">&lt;-</span> time_plnpca</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Then, we implemented MRRR:</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="do">## MRRR</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="do">## Compare with MRRR</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>mrrr_run <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, X, rank0, <span class="at">q=</span><span class="cn">NULL</span>, <span class="at">family=</span><span class="fu">list</span>(<span class="fu">poisson</span>()),</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                     <span class="at">familygroup=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">ncol</span>(Y)), <span class="at">epsilon =</span> <span class="fl">1e-4</span>, <span class="at">sv.tol =</span> <span class="fl">1e-2</span>,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                     <span class="at">maxIter =</span> <span class="dv">2000</span>, <span class="at">trace=</span><span class="cn">TRUE</span>, <span class="at">truncflag=</span><span class="cn">FALSE</span>, <span class="at">trunc=</span><span class="dv">500</span>){</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="co"># epsilon = 1e-4; sv.tol = 1e-2; maxIter = 30; trace=TRUE</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="co"># Y &lt;- X_count; X &lt;- cbind(Z, H); rank0 = r + ncol(Z)</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="fu">require</span>(rrpack)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  </span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Y); p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  </span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(q)){</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    rank0 <span class="ot">&lt;-</span> rank0<span class="sc">+</span>q</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X, <span class="fu">diag</span>(n))</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  }</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="cf">if</span>(truncflag){</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="do">## Trunction</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    Y[Y<span class="sc">&gt;</span>trunc] <span class="ot">&lt;-</span> trunc</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    </span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  }</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>  svdX0d1 <span class="ot">&lt;-</span> <span class="fu">svd</span>(X)<span class="sc">$</span>d[<span class="dv">1</span>]</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>  init1 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">kappaC0 =</span> svdX0d1 <span class="sc">*</span> <span class="dv">5</span>)</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>  offset <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>  control <span class="ot">=</span> <span class="fu">list</span>(<span class="at">epsilon =</span> epsilon, <span class="at">sv.tol =</span> sv.tol, <span class="at">maxit =</span> maxIter,</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>                 <span class="at">trace =</span> trace, <span class="at">gammaC0 =</span> <span class="fl">1.1</span>, <span class="at">plot.cv =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>                 <span class="at">conv.obj =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>  fit.mrrr <span class="ot">&lt;-</span> <span class="fu">mrrr</span>(<span class="at">Y=</span>Y, <span class="at">X=</span>X[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">family =</span> family, <span class="at">familygroup =</span> familygroup,</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>                   <span class="at">penstr =</span> <span class="fu">list</span>(<span class="at">penaltySVD =</span> <span class="st">&quot;rankCon&quot;</span>, <span class="at">lambdaSVD =</span> <span class="dv">1</span>),</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>                   <span class="at">control =</span> control, <span class="at">init =</span> init1, <span class="at">maxrank =</span> rank0)</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>  </span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>  <span class="fu">return</span>(fit.mrrr)</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>}</span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a>res_mrrr <span class="ot">&lt;-</span> <span class="fu">mrrr_run</span>(X_count, <span class="fu">cbind</span>(Z,H), r<span class="sc">+</span><span class="fu">ncol</span>(Z), <span class="at">q=</span>q, <span class="at">truncflag=</span> <span class="cn">TRUE</span>, <span class="at">trunc=</span><span class="fl">1e4</span>)</span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>time_mrrr <span class="ot">&lt;-</span> toc[<span class="dv">3</span>] <span class="sc">-</span> tic[<span class="dv">3</span>]</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>hbbeta_mrrr <span class="ot">&lt;-</span><span class="fu">t</span>(res_mrrr<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(<span class="fu">cbind</span>(Z,H)), ])</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>Theta_hb <span class="ot">&lt;-</span> (res_mrrr<span class="sc">$</span>coef[(<span class="fu">ncol</span>(<span class="fu">cbind</span>(Z,H))<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span> (<span class="fu">nrow</span>(<span class="fu">cbind</span>(Z,H))<span class="sc">+</span><span class="fu">ncol</span>(<span class="fu">cbind</span>(Z,H))), ])</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>svdTheta <span class="ot">&lt;-</span> <span class="fu">svd</span>(Theta_hb, <span class="at">nu=</span>q, <span class="at">nv=</span>q)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>metricList<span class="sc">$</span>MRRR<span class="sc">$</span>F_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(svdTheta<span class="sc">$</span>u, F0)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>metricList<span class="sc">$</span>MRRR<span class="sc">$</span>B_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(svdTheta<span class="sc">$</span>v, B0)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>alpha_mrrr <span class="ot">&lt;-</span> hbbeta_mrrr[,<span class="dv">1</span><span class="sc">:</span>k]</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>beta_mrrr <span class="ot">&lt;-</span> hbbeta_mrrr[,(k<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(k<span class="sc">+</span>d)]</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>metricList<span class="sc">$</span>MRRR<span class="sc">$</span>alpha_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(alpha_mrrr<span class="sc">-</span> alpha0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(alpha0))</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>metricList<span class="sc">$</span>MRRR<span class="sc">$</span>beta_norm1 <span class="ot">&lt;-</span> <span class="fu">norm1_vec</span>(beta_mrrr<span class="sc">-</span> bbeta0)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">abs</span>(bbeta0))</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>metricList<span class="sc">$</span>MRRR<span class="sc">$</span>time <span class="ot">&lt;-</span> time_mrrr</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Finally, we implement FAST that takes into account spatial
dependence among units, but unable to account for additional
covariates.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="do">## FAST</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>fast_run <span class="ot">&lt;-</span> <span class="cf">function</span>(X_count, Adj_sp, q, <span class="at">verbose=</span><span class="cn">TRUE</span>, <span class="at">epsELBO=</span><span class="fl">1e-8</span>){</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">require</span>(ProFAST)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  reslist <span class="ot">&lt;-</span> <span class="fu">FAST_run</span>(<span class="at">XList =</span> <span class="fu">list</span>(X_count), </span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                      <span class="at">AdjList =</span> <span class="fu">list</span>(Adj_sp), <span class="at">q =</span> q, <span class="at">fit.model =</span> <span class="st">&#39;poisson&#39;</span>, </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>                      <span class="at">verbose=</span>verbose, <span class="at">epsLogLik=</span>epsELBO)</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  reslist<span class="sc">$</span>hV <span class="ot">&lt;-</span> reslist<span class="sc">$</span>hV[[<span class="dv">1</span>]]</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="fu">return</span>(reslist)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>}</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>res_fast <span class="ot">&lt;-</span> <span class="fu">fast_run</span>(X_count, Adj_sp, <span class="at">q=</span>q, <span class="at">verbose=</span><span class="cn">TRUE</span>, <span class="at">epsELBO=</span><span class="fl">1e-8</span>)</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>time_fast <span class="ot">&lt;-</span> toc[<span class="dv">3</span>] <span class="sc">-</span> tic[<span class="dv">3</span>]</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>metricList<span class="sc">$</span>FAST<span class="sc">$</span>F_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_fast<span class="sc">$</span>hV, F0)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>metricList<span class="sc">$</span>FAST<span class="sc">$</span>B_tr <span class="ot">&lt;-</span> <span class="fu">trace_statistic_fun</span>(res_fast<span class="sc">$</span>W, B0)</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>metricList<span class="sc">$</span>FAST<span class="sc">$</span>time <span class="ot">&lt;-</span> time_fast</span></code></pre></div>
</div>
<div id="visualize-the-comparison-of-performance" class="section level2">
<h2>Visualize the comparison of performance</h2>
<p>Next, we summarized the metrics for COAP and other compared methods
in a dataframe object.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>list2vec <span class="ot">&lt;-</span> <span class="cf">function</span>(xlist){</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">length</span>(xlist)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  me <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, nn)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  idx_noNA <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(xlist, <span class="cf">function</span>(x) <span class="sc">!</span><span class="fu">is.null</span>(x)))</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="cf">for</span>(r <span class="cf">in</span> idx_noNA) me[r] <span class="ot">&lt;-</span> xlist[[r]]</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="fu">return</span>(me)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>}</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>dat_metric <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Tr_F =</span> <span class="fu">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="sc">$</span>F_tr), </span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>                         <span class="at">Tr_B =</span> <span class="fu">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="sc">$</span>B_tr),</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>                         <span class="at">err_alpha =</span><span class="fu">list2vec</span>(<span class="fu">lapply</span>(metricList, <span class="cf">function</span>(x) x<span class="sc">$</span>alpha_norm1)),</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>                         <span class="at">err_beta =</span> <span class="fu">list2vec</span>(<span class="fu">lapply</span>(metricList, <span class="cf">function</span>(x) x<span class="sc">$</span>beta_norm1)),</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>                         <span class="at">time =</span> <span class="fu">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="sc">$</span>time),</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>                         <span class="at">Method =</span> <span class="fu">names</span>(metricList))</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>dat_metric<span class="sc">$</span>Method <span class="ot">&lt;-</span> <span class="fu">factor</span>(dat_metric<span class="sc">$</span>Method, <span class="at">levels=</span>dat_metric<span class="sc">$</span>Method)</span></code></pre></div>
<p>Plot the results for COAP and other methods, which suggests that COAP
achieves better estimation accuracy for the quantiites of interest.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span><span class="fu">subset</span>(dat_metric, <span class="sc">!</span><span class="fu">is.na</span>(Tr_B)), <span class="fu">aes</span>(<span class="at">x=</span> Method, <span class="at">y=</span>Tr_B, <span class="at">fill=</span>Method)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span><span class="fu">subset</span>(dat_metric, <span class="sc">!</span><span class="fu">is.na</span>(Tr_F)), <span class="fu">aes</span>(<span class="at">x=</span> Method, <span class="at">y=</span>Tr_F, <span class="at">fill=</span>Method)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="cn">NULL</span>)<span class="sc">+</span> <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span><span class="fu">subset</span>(dat_metric, <span class="sc">!</span><span class="fu">is.na</span>(err_alpha)), <span class="fu">aes</span>(<span class="at">x=</span> Method, <span class="at">y=</span>err_alpha, <span class="at">fill=</span>Method)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="cn">NULL</span>)<span class="sc">+</span> <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span><span class="fu">subset</span>(dat_metric, <span class="sc">!</span><span class="fu">is.na</span>(err_beta)), <span class="fu">aes</span>(<span class="at">x=</span> Method, <span class="at">y=</span>err_beta, <span class="at">fill=</span>Method)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="cn">NULL</span>)<span class="sc">+</span> <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="fu">plot_grid</span>(p1,p2,p3, p4, <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="select-the-parameters" class="section level2">
<h2>Select the parameters</h2>
<p>We applied the singular value ratio based method to select the number
of factors and the rank of coefficient matrix. The results showed that
the SVR method has the potential to identify the true values.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>res1 <span class="ot">&lt;-</span> <span class="fu">chooseParams</span>(X_count, Adj_sp, H, Z, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="at">q_true=</span>q, <span class="at">q_est=</span>res1[<span class="st">&#39;hq&#39;</span>]))</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="at">r_true=</span>r, <span class="at">r_est=</span>res1[<span class="st">&#39;hr&#39;</span>]))</span></code></pre></div>
<details>
<summary>
<strong>Session Info</strong>
</summary>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#&gt; R version 4.4.1 (2024-06-14 ucrt)</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt; Running under: Windows 11 x64 (build 26100)</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; [1] LC_COLLATE=C                               </span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.utf8   </span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.utf8</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#&gt; [4] LC_NUMERIC=C                               </span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.utf8    </span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; time zone: Asia/Shanghai</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; tzcode source: internal</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt;  [1] digest_0.6.37     R6_2.5.1          fastmap_1.2.0     xfun_0.47        </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt;  [5] cachem_1.1.0      knitr_1.48        htmltools_0.5.8.1 rmarkdown_2.28   </span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt;  [9] lifecycle_1.0.4   cli_3.6.3         sass_0.4.9        jquerylib_0.1.4  </span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; [13] compiler_4.4.1    rstudioapi_0.16.0 tools_4.4.1       evaluate_1.0.0   </span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; [17] bslib_0.8.0       yaml_2.3.10       rlang_1.1.4       jsonlite_1.8.9</span></span></code></pre></div>
</details>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
