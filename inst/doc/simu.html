<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Wei Liu" />

<meta name="date" content="2024-05-26" />

<title>SpaCOAP: simulation</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SpaCOAP: simulation</h1>
<h4 class="author">Wei Liu</h4>
<h4 class="date">2024-05-26</h4>



<p>This vignette introduces the usage of SpaCOAP for the analysis of high-dimensional count data with additional high-dimensional covariates, by comparison with other methods.</p>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(SpaCOAP)</a></code></pre></div>
<div id="generate-the-simulated-data" class="section level2">
<h2>Generate the simulated data</h2>
<p>First, we generate the data simulated data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">width &lt;-<span class="st"> </span><span class="dv">20</span>; height &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb2-2" title="2">n &lt;-<span class="st"> </span>width<span class="op">*</span>height</a>
<a class="sourceLine" id="cb2-3" title="3">p=<span class="dv">500</span></a>
<a class="sourceLine" id="cb2-4" title="4">q =<span class="st"> </span><span class="dv">5</span>; d &lt;-<span class="st"> </span><span class="dv">40</span>; k &lt;-<span class="st"> </span><span class="dv">3</span>; r &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb2-5" title="5">bandwidth &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb2-6" title="6">rho&lt;-<span class="st">   </span><span class="kw">c</span>(<span class="dv">8</span>,<span class="fl">0.6</span>) </a>
<a class="sourceLine" id="cb2-7" title="7">sigma2_eps=<span class="dv">1</span></a>
<a class="sourceLine" id="cb2-8" title="8">datlist &lt;-<span class="st"> </span><span class="kw">gendata_spacoap</span>(<span class="dt">seed=</span><span class="dv">1</span>, <span class="dt">width=</span>width, <span class="dt">height =</span> height,</a>
<a class="sourceLine" id="cb2-9" title="9">                           <span class="dt">p=</span>p, <span class="dt">q=</span>q, <span class="dt">d=</span>d, <span class="dt">k=</span>k, <span class="dt">rank0 =</span> r, <span class="dt">bandwidth=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-10" title="10">                           <span class="dt">eta0 =</span> <span class="fl">0.5</span>, <span class="dt">rho=</span>rho, <span class="dt">sigma2_eps=</span>sigma2_eps)</a>
<a class="sourceLine" id="cb2-11" title="11">X_count &lt;-<span class="st"> </span>datlist<span class="op">$</span>X; H &lt;-<span class="st"> </span>datlist<span class="op">$</span>H; Z &lt;-<span class="st"> </span>datlist<span class="op">$</span>Z</a>
<a class="sourceLine" id="cb2-12" title="12">F0 &lt;-<span class="st"> </span>datlist<span class="op">$</span>F0; B0 &lt;-<span class="st"> </span>datlist<span class="op">$</span>B0</a>
<a class="sourceLine" id="cb2-13" title="13">bbeta0 &lt;-<span class="st"> </span>datlist<span class="op">$</span>bbeta0; alpha0 &lt;-<span class="st"> </span>datlist<span class="op">$</span>alpha0</a>
<a class="sourceLine" id="cb2-14" title="14">Adj_sp &lt;-<span class="st"> </span>SpaCOAP<span class="op">:::</span><span class="kw">getneighbor_weightmat</span>(datlist<span class="op">$</span>pos, <span class="fl">1.1</span>,  bandwidth)</a></code></pre></div>
<p>Fit the SpaCOAP model using the function <code>SpaCOAP()</code> in the R package <code>SpaCOAP</code>. Users can use <code>?SpaCOAP</code> to see the details about this function.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">reslist &lt;-<span class="st"> </span><span class="kw">SpaCOAP</span>(X_count,Adj_sp, H, <span class="dt">Z =</span> Z, <span class="dt">rank_use =</span> r, <span class="dt">q=</span>q)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">str</span>(reslist)</a></code></pre></div>
<p>Check the increased property of the envidence lower bound function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb4-2" title="2">dat_iter &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">iter=</span><span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(reslist<span class="op">$</span>ELBO_seq[<span class="op">-</span><span class="dv">1</span>]), <span class="dt">ELBO=</span>reslist<span class="op">$</span>ELBO_seq[<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">ggplot</span>(<span class="dt">data=</span>dat_iter, <span class="kw">aes</span>(<span class="dt">x=</span>iter, <span class="dt">y=</span>ELBO)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>(<span class="dt">base_size =</span> <span class="dv">20</span>)</a></code></pre></div>
<p>We calculate the metrics to measure the estimatioin accuracy, where the trace statistic is used to measure the estimation accuracy of loading matrix and prediction accuracy of factor matrix, and the mean absolute error is adopted to measure the estimation error of bbeta and alpha.</p>
<p>First, we define the metric functions:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">norm1_vec &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">mean</span>(<span class="kw">abs</span>(x))</a>
<a class="sourceLine" id="cb5-2" title="2">trace_statistic_fun &lt;-<span class="st"> </span><span class="cf">function</span>(H, H0){</a>
<a class="sourceLine" id="cb5-3" title="3">  </a>
<a class="sourceLine" id="cb5-4" title="4">  tr_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">diag</span>(x))</a>
<a class="sourceLine" id="cb5-5" title="5">  mat1 &lt;-<span class="st"> </span><span class="kw">t</span>(H0) <span class="op">%*%</span><span class="st"> </span>H <span class="op">%*%</span><span class="st"> </span><span class="kw">qr.solve</span>(<span class="kw">t</span>(H) <span class="op">%*%</span><span class="st"> </span>H) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(H) <span class="op">%*%</span><span class="st"> </span>H0</a>
<a class="sourceLine" id="cb5-6" title="6">  </a>
<a class="sourceLine" id="cb5-7" title="7">  <span class="kw">tr_fun</span>(mat1) <span class="op">/</span><span class="st"> </span><span class="kw">tr_fun</span>(<span class="kw">t</span>(H0) <span class="op">%*%</span><span class="st"> </span>H0)</a>
<a class="sourceLine" id="cb5-8" title="8">  </a>
<a class="sourceLine" id="cb5-9" title="9">}</a></code></pre></div>
<p>Then, we calculate the quantities for SpaCOAP.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">metricList &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb6-2" title="2">metricList<span class="op">$</span>SpaCOAP &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb6-3" title="3">metricList<span class="op">$</span>SpaCOAP<span class="op">$</span>F_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(reslist<span class="op">$</span>F, F0)</a>
<a class="sourceLine" id="cb6-4" title="4">metricList<span class="op">$</span>SpaCOAP<span class="op">$</span>B_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(reslist<span class="op">$</span>B, B0)</a>
<a class="sourceLine" id="cb6-5" title="5">metricList<span class="op">$</span>SpaCOAP<span class="op">$</span>alpha_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(reslist<span class="op">$</span>alpha<span class="op">-</span><span class="st"> </span>alpha0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(alpha0))  </a>
<a class="sourceLine" id="cb6-6" title="6">metricList<span class="op">$</span>SpaCOAP<span class="op">$</span>beta_norm1&lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(reslist<span class="op">$</span>bbeta<span class="op">-</span><span class="st"> </span>bbeta0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(bbeta0))</a>
<a class="sourceLine" id="cb6-7" title="7">metricList<span class="op">$</span>SpaCOAP<span class="op">$</span>time &lt;-<span class="st"> </span>reslist<span class="op">$</span>time_use</a></code></pre></div>
</div>
<div id="compare-with-other-methods" class="section level2">
<h2>Compare with other methods</h2>
<p>We compare SpaCOAP with various prominent methods in the literature. (1) COAP performs covariate-argumented Poisson factor model with the consideration of the low-rank structure of the coefficient matrix, but falls short in accounting for the spatial dependence among units, which is implemented in the R package <strong>COAP</strong>; (2) PLNPCA performs covariate-argumented PCA without considering the low-rank structure of the coefficient matrix and spatial dependence among units, which is implemented in the R package <strong>PLNmodels</strong>; (3) Multi-response reduced-rank Poisson regression model (MRRR) performs the estimation of low-rank coefficient matrix and factor part by treating them as a single entity, and fails to account for spatial dependence among units, which is implemented in <strong>rrpack</strong> R package. (4) Spatial Poisson factor model, called FAST, takes into account spatial dependence among units, but unable to account for additional covariates, which is implemented in the R package <strong>ProFAST</strong>.</p>
<p>First, we implement COAP method:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">library</span>(COAP)</a>
<a class="sourceLine" id="cb7-2" title="2">tic &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb7-3" title="3">res_coap &lt;-<span class="st"> </span><span class="kw">RR_COAP</span>(X_count, <span class="dt">Z =</span> <span class="kw">cbind</span>(Z, H), <span class="dt">rank_use=</span> k<span class="op">+</span>r, <span class="dt">q=</span><span class="dv">5</span>, <span class="dt">epsELBO =</span> <span class="fl">1e-9</span>)</a>
<a class="sourceLine" id="cb7-4" title="4">toc &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb7-5" title="5">time_coap &lt;-<span class="st"> </span>toc[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>tic[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb7-6" title="6">metricList<span class="op">$</span>COAP<span class="op">$</span>F_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_coap<span class="op">$</span>H, F0)</a>
<a class="sourceLine" id="cb7-7" title="7">metricList<span class="op">$</span>COAP<span class="op">$</span>B_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_coap<span class="op">$</span>B, B0)</a>
<a class="sourceLine" id="cb7-8" title="8">alpha_coap &lt;-<span class="st"> </span>res_coap<span class="op">$</span>bbeta[,<span class="dv">1</span><span class="op">:</span>k]</a>
<a class="sourceLine" id="cb7-9" title="9">beta_coap &lt;-<span class="st"> </span>res_coap<span class="op">$</span>bbeta[,(k<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(k<span class="op">+</span>d)]</a>
<a class="sourceLine" id="cb7-10" title="10">metricList<span class="op">$</span>COAP<span class="op">$</span>alpha_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(alpha_coap<span class="op">-</span><span class="st"> </span>alpha0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(alpha0))</a>
<a class="sourceLine" id="cb7-11" title="11">metricList<span class="op">$</span>COAP<span class="op">$</span>beta_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(beta_coap<span class="op">-</span><span class="st"> </span>bbeta0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(bbeta0))</a>
<a class="sourceLine" id="cb7-12" title="12">metricList<span class="op">$</span>COAP<span class="op">$</span>time &lt;-<span class="st"> </span>time_coap</a></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Secondly, we implemented the PLNPCA and record the metrics that measure the estimation accuracy and computational cost.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"></a>
<a class="sourceLine" id="cb8-2" title="2">PLNPCA_run &lt;-<span class="st"> </span><span class="cf">function</span>(X_count, covariates, q,  <span class="dt">Offset=</span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(X_count)), <span class="dt">workers=</span><span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb8-3" title="3">                       <span class="dt">maxIter=</span><span class="dv">10000</span>,<span class="dt">ftol_rel=</span><span class="fl">1e-8</span>, <span class="dt">xtol_rel=</span> <span class="fl">1e-4</span>){</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="kw">require</span>(PLNmodels)</a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(workers)){</a>
<a class="sourceLine" id="cb8-6" title="6">    future<span class="op">::</span><span class="kw">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="dt">workers =</span> workers)</a>
<a class="sourceLine" id="cb8-7" title="7">  }</a>
<a class="sourceLine" id="cb8-8" title="8">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.character</span>(Offset)){</a>
<a class="sourceLine" id="cb8-9" title="9">    dat_plnpca &lt;-<span class="st"> </span><span class="kw">prepare_data</span>(X_count, covariates)</a>
<a class="sourceLine" id="cb8-10" title="10">    dat_plnpca<span class="op">$</span>Offset &lt;-<span class="st"> </span>Offset</a>
<a class="sourceLine" id="cb8-11" title="11">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb8-12" title="12">    dat_plnpca &lt;-<span class="st"> </span><span class="kw">prepare_data</span>(X_count, covariates, <span class="dt">offset =</span> Offset)</a>
<a class="sourceLine" id="cb8-13" title="13">  }</a>
<a class="sourceLine" id="cb8-14" title="14">  </a>
<a class="sourceLine" id="cb8-15" title="15">  d &lt;-<span class="st"> </span><span class="kw">ncol</span>(covariates)</a>
<a class="sourceLine" id="cb8-16" title="16">  <span class="co">#  offset(log(Offset))+</span></a>
<a class="sourceLine" id="cb8-17" title="17">  formu &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Abundance ~ 1 + offset(log(Offset))+&quot;</span>,<span class="kw">paste</span>(<span class="kw">paste0</span>(<span class="st">&quot;V&quot;</span>,<span class="dv">1</span><span class="op">:</span>d), <span class="dt">collapse =</span> <span class="st">&#39;+&#39;</span>))</a>
<a class="sourceLine" id="cb8-18" title="18">  control_use  &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">maxeval=</span>maxIter, <span class="dt">ftol_rel=</span>ftol_rel, <span class="dt">xtol_rel=</span> ftol_rel)</a>
<a class="sourceLine" id="cb8-19" title="19">  control_main &lt;-<span class="st"> </span><span class="kw">PLNPCA_param</span>(</a>
<a class="sourceLine" id="cb8-20" title="20">    <span class="dt">backend =</span> <span class="st">&quot;nlopt&quot;</span>,</a>
<a class="sourceLine" id="cb8-21" title="21">    <span class="dt">trace =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-22" title="22">    <span class="dt">config_optim =</span> control_use,</a>
<a class="sourceLine" id="cb8-23" title="23">    <span class="dt">inception =</span> <span class="ot">NULL</span></a>
<a class="sourceLine" id="cb8-24" title="24">  )</a>
<a class="sourceLine" id="cb8-25" title="25">  </a>
<a class="sourceLine" id="cb8-26" title="26">  myPCA &lt;-<span class="st"> </span><span class="kw">PLNPCA</span>(<span class="kw">as.formula</span>(formu), <span class="dt">data =</span> dat_plnpca, <span class="dt">ranks =</span> q,  <span class="dt">control =</span> control_main)</a>
<a class="sourceLine" id="cb8-27" title="27">  </a>
<a class="sourceLine" id="cb8-28" title="28">  myPCA1 &lt;-<span class="st"> </span><span class="kw">getBestModel</span>(myPCA)</a>
<a class="sourceLine" id="cb8-29" title="29">  myPCA1<span class="op">$</span>scores</a>
<a class="sourceLine" id="cb8-30" title="30">  </a>
<a class="sourceLine" id="cb8-31" title="31">  res_plnpca &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">PCs=</span> myPCA1<span class="op">$</span>scores, <span class="dt">bbeta=</span> myPCA1<span class="op">$</span>model_par<span class="op">$</span>B, </a>
<a class="sourceLine" id="cb8-32" title="32">                     <span class="dt">loadings=</span>myPCA1<span class="op">$</span>model_par<span class="op">$</span>C)</a>
<a class="sourceLine" id="cb8-33" title="33">  </a>
<a class="sourceLine" id="cb8-34" title="34">  <span class="kw">return</span>(res_plnpca)</a>
<a class="sourceLine" id="cb8-35" title="35">}</a>
<a class="sourceLine" id="cb8-36" title="36"></a>
<a class="sourceLine" id="cb8-37" title="37">tic &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb8-38" title="38">res_plnpca &lt;-<span class="st"> </span><span class="kw">PLNPCA_run</span>(X_count, <span class="kw">cbind</span>(Z[,<span class="op">-</span><span class="dv">1</span>],H), <span class="dt">q=</span>q)</a>
<a class="sourceLine" id="cb8-39" title="39">toc &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb8-40" title="40">time_plnpca &lt;-<span class="st"> </span>toc[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>tic[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb8-41" title="41">  </a>
<a class="sourceLine" id="cb8-42" title="42">metricList<span class="op">$</span>PLNPCA<span class="op">$</span>F_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_plnpca<span class="op">$</span>PCs, F0)</a>
<a class="sourceLine" id="cb8-43" title="43">metricList<span class="op">$</span>PLNPCA<span class="op">$</span>B_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_plnpca<span class="op">$</span>loadings, B0)</a>
<a class="sourceLine" id="cb8-44" title="44">alpha_plnpca &lt;-<span class="st"> </span><span class="kw">t</span>(res_plnpca<span class="op">$</span>bbeta[<span class="dv">1</span><span class="op">:</span>k,])</a>
<a class="sourceLine" id="cb8-45" title="45">beta_plnpca &lt;-<span class="st"> </span><span class="kw">t</span>(res_plnpca<span class="op">$</span>bbeta[(k<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(k<span class="op">+</span>d),])</a>
<a class="sourceLine" id="cb8-46" title="46">metricList<span class="op">$</span>PLNPCA<span class="op">$</span>alpha_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(alpha_plnpca<span class="op">-</span><span class="st"> </span>alpha0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(alpha0))</a>
<a class="sourceLine" id="cb8-47" title="47">metricList<span class="op">$</span>PLNPCA<span class="op">$</span>beta_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(beta_plnpca<span class="op">-</span><span class="st"> </span>bbeta0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(bbeta0))</a>
<a class="sourceLine" id="cb8-48" title="48">metricList<span class="op">$</span>PLNPCA<span class="op">$</span>time &lt;-<span class="st"> </span>time_plnpca</a></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Then, we implemented MRRR:</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co">## MRRR</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">## Compare with MRRR</span></a>
<a class="sourceLine" id="cb9-3" title="3">mrrr_run &lt;-<span class="st"> </span><span class="cf">function</span>(Y, X, rank0, <span class="dt">q=</span><span class="ot">NULL</span>, <span class="dt">family=</span><span class="kw">list</span>(<span class="kw">poisson</span>()),</a>
<a class="sourceLine" id="cb9-4" title="4">                     <span class="dt">familygroup=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">ncol</span>(Y)), <span class="dt">epsilon =</span> <span class="fl">1e-4</span>, <span class="dt">sv.tol =</span> <span class="fl">1e-2</span>,</a>
<a class="sourceLine" id="cb9-5" title="5">                     <span class="dt">maxIter =</span> <span class="dv">2000</span>, <span class="dt">trace=</span><span class="ot">TRUE</span>, <span class="dt">truncflag=</span><span class="ot">FALSE</span>, <span class="dt">trunc=</span><span class="dv">500</span>){</a>
<a class="sourceLine" id="cb9-6" title="6">  <span class="co"># epsilon = 1e-4; sv.tol = 1e-2; maxIter = 30; trace=TRUE</span></a>
<a class="sourceLine" id="cb9-7" title="7">  <span class="co"># Y &lt;- X_count; X &lt;- cbind(Z, H); rank0 = r + ncol(Z)</span></a>
<a class="sourceLine" id="cb9-8" title="8">  </a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="kw">require</span>(rrpack)</a>
<a class="sourceLine" id="cb9-10" title="10">  </a>
<a class="sourceLine" id="cb9-11" title="11">  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(Y); p &lt;-<span class="st"> </span><span class="kw">ncol</span>(Y)</a>
<a class="sourceLine" id="cb9-12" title="12">  </a>
<a class="sourceLine" id="cb9-13" title="13">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(q)){</a>
<a class="sourceLine" id="cb9-14" title="14">    rank0 &lt;-<span class="st"> </span>rank0<span class="op">+</span>q</a>
<a class="sourceLine" id="cb9-15" title="15">    X &lt;-<span class="st"> </span><span class="kw">cbind</span>(X, <span class="kw">diag</span>(n))</a>
<a class="sourceLine" id="cb9-16" title="16">  }</a>
<a class="sourceLine" id="cb9-17" title="17">  <span class="cf">if</span>(truncflag){</a>
<a class="sourceLine" id="cb9-18" title="18">    <span class="co">## Trunction</span></a>
<a class="sourceLine" id="cb9-19" title="19">    Y[Y<span class="op">&gt;</span>trunc] &lt;-<span class="st"> </span>trunc</a>
<a class="sourceLine" id="cb9-20" title="20">    </a>
<a class="sourceLine" id="cb9-21" title="21">  }</a>
<a class="sourceLine" id="cb9-22" title="22">  </a>
<a class="sourceLine" id="cb9-23" title="23">  svdX0d1 &lt;-<span class="st"> </span><span class="kw">svd</span>(X)<span class="op">$</span>d[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-24" title="24">  init1 =<span class="st"> </span><span class="kw">list</span>(<span class="dt">kappaC0 =</span> svdX0d1 <span class="op">*</span><span class="st"> </span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb9-25" title="25">  offset =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb9-26" title="26">  control =<span class="st"> </span><span class="kw">list</span>(<span class="dt">epsilon =</span> epsilon, <span class="dt">sv.tol =</span> sv.tol, <span class="dt">maxit =</span> maxIter,</a>
<a class="sourceLine" id="cb9-27" title="27">                 <span class="dt">trace =</span> trace, <span class="dt">gammaC0 =</span> <span class="fl">1.1</span>, <span class="dt">plot.cv =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb9-28" title="28">                 <span class="dt">conv.obj =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-29" title="29">  fit.mrrr &lt;-<span class="st"> </span><span class="kw">mrrr</span>(<span class="dt">Y=</span>Y, <span class="dt">X=</span>X[,<span class="op">-</span><span class="dv">1</span>], <span class="dt">family =</span> family, <span class="dt">familygroup =</span> familygroup,</a>
<a class="sourceLine" id="cb9-30" title="30">                   <span class="dt">penstr =</span> <span class="kw">list</span>(<span class="dt">penaltySVD =</span> <span class="st">&quot;rankCon&quot;</span>, <span class="dt">lambdaSVD =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb9-31" title="31">                   <span class="dt">control =</span> control, <span class="dt">init =</span> init1, <span class="dt">maxrank =</span> rank0)</a>
<a class="sourceLine" id="cb9-32" title="32">  </a>
<a class="sourceLine" id="cb9-33" title="33">  <span class="kw">return</span>(fit.mrrr)</a>
<a class="sourceLine" id="cb9-34" title="34">}</a>
<a class="sourceLine" id="cb9-35" title="35">tic &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb9-36" title="36">res_mrrr &lt;-<span class="st"> </span><span class="kw">mrrr_run</span>(X_count, <span class="kw">cbind</span>(Z,H), r<span class="op">+</span><span class="kw">ncol</span>(Z), <span class="dt">q=</span>q, <span class="dt">truncflag=</span> <span class="ot">TRUE</span>, <span class="dt">trunc=</span><span class="fl">1e4</span>)</a>
<a class="sourceLine" id="cb9-37" title="37">toc &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb9-38" title="38">time_mrrr &lt;-<span class="st"> </span>toc[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>tic[<span class="dv">3</span>]</a></code></pre></div>
<p>Calculate the metrics for MRRR.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">hbbeta_mrrr &lt;-<span class="kw">t</span>(res_mrrr<span class="op">$</span>coef[<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(<span class="kw">cbind</span>(Z,H)), ])</a>
<a class="sourceLine" id="cb10-2" title="2">Theta_hb &lt;-<span class="st"> </span>(res_mrrr<span class="op">$</span>coef[(<span class="kw">ncol</span>(<span class="kw">cbind</span>(Z,H))<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span><span class="st"> </span>(<span class="kw">nrow</span>(<span class="kw">cbind</span>(Z,H))<span class="op">+</span><span class="kw">ncol</span>(<span class="kw">cbind</span>(Z,H))), ])</a>
<a class="sourceLine" id="cb10-3" title="3">svdTheta &lt;-<span class="st"> </span><span class="kw">svd</span>(Theta_hb, <span class="dt">nu=</span>q, <span class="dt">nv=</span>q)</a>
<a class="sourceLine" id="cb10-4" title="4">metricList<span class="op">$</span>MRRR<span class="op">$</span>F_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(svdTheta<span class="op">$</span>u, F0)</a>
<a class="sourceLine" id="cb10-5" title="5">metricList<span class="op">$</span>MRRR<span class="op">$</span>B_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(svdTheta<span class="op">$</span>v, B0)</a>
<a class="sourceLine" id="cb10-6" title="6">alpha_mrrr &lt;-<span class="st"> </span>hbbeta_mrrr[,<span class="dv">1</span><span class="op">:</span>k]</a>
<a class="sourceLine" id="cb10-7" title="7">beta_mrrr &lt;-<span class="st"> </span>hbbeta_mrrr[,(k<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(k<span class="op">+</span>d)]</a>
<a class="sourceLine" id="cb10-8" title="8">metricList<span class="op">$</span>MRRR<span class="op">$</span>alpha_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(alpha_mrrr<span class="op">-</span><span class="st"> </span>alpha0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(alpha0))</a>
<a class="sourceLine" id="cb10-9" title="9">metricList<span class="op">$</span>MRRR<span class="op">$</span>beta_norm1 &lt;-<span class="st"> </span><span class="kw">norm1_vec</span>(beta_mrrr<span class="op">-</span><span class="st"> </span>bbeta0)<span class="op">/</span><span class="kw">mean</span>(<span class="kw">abs</span>(bbeta0))</a>
<a class="sourceLine" id="cb10-10" title="10">metricList<span class="op">$</span>MRRR<span class="op">$</span>time &lt;-<span class="st"> </span>time_mrrr</a></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Finally, we implement FAST that takes into account spatial dependence among units, but unable to account for additional covariates.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co">## FAST</span></a>
<a class="sourceLine" id="cb11-2" title="2">fast_run &lt;-<span class="st"> </span><span class="cf">function</span>(X_count, Adj_sp, q, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">epsELBO=</span><span class="fl">1e-8</span>){</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="kw">require</span>(ProFAST)</a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5">  reslist &lt;-<span class="st"> </span><span class="kw">FAST_run</span>(<span class="dt">XList =</span> <span class="kw">list</span>(X_count), </a>
<a class="sourceLine" id="cb11-6" title="6">                      <span class="dt">AdjList =</span> <span class="kw">list</span>(Adj_sp), <span class="dt">q =</span> q, <span class="dt">fit.model =</span> <span class="st">&#39;poisson&#39;</span>, </a>
<a class="sourceLine" id="cb11-7" title="7">                      <span class="dt">verbose=</span>verbose, <span class="dt">epsLogLik=</span>epsELBO)</a>
<a class="sourceLine" id="cb11-8" title="8">  reslist<span class="op">$</span>hV &lt;-<span class="st"> </span>reslist<span class="op">$</span>hV[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="kw">return</span>(reslist)</a>
<a class="sourceLine" id="cb11-10" title="10">}</a>
<a class="sourceLine" id="cb11-11" title="11">tic &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb11-12" title="12">res_fast &lt;-<span class="st"> </span><span class="kw">fast_run</span>(X_count, Adj_sp, <span class="dt">q=</span>q, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">epsELBO=</span><span class="fl">1e-8</span>)</a>
<a class="sourceLine" id="cb11-13" title="13">toc &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb11-14" title="14">time_fast &lt;-<span class="st"> </span>toc[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>tic[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb11-15" title="15">metricList<span class="op">$</span>FAST<span class="op">$</span>F_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_fast<span class="op">$</span>hV, F0)</a>
<a class="sourceLine" id="cb11-16" title="16">metricList<span class="op">$</span>FAST<span class="op">$</span>B_tr &lt;-<span class="st"> </span><span class="kw">trace_statistic_fun</span>(res_fast<span class="op">$</span>W, B0)</a>
<a class="sourceLine" id="cb11-17" title="17">metricList<span class="op">$</span>FAST<span class="op">$</span>time &lt;-<span class="st"> </span>time_fast</a></code></pre></div>
</div>
<div id="visualize-the-comparison-of-performance" class="section level2">
<h2>Visualize the comparison of performance</h2>
<p>Next, we summarized the metrics for COAP and other compared methods in a dataframe object.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">list2vec &lt;-<span class="st"> </span><span class="cf">function</span>(xlist){</a>
<a class="sourceLine" id="cb12-2" title="2">  nn &lt;-<span class="st"> </span><span class="kw">length</span>(xlist)</a>
<a class="sourceLine" id="cb12-3" title="3">  me &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, nn)</a>
<a class="sourceLine" id="cb12-4" title="4">  idx_noNA &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(xlist, <span class="cf">function</span>(x) <span class="op">!</span><span class="kw">is.null</span>(x)))</a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="cf">for</span>(r <span class="cf">in</span> idx_noNA) me[r] &lt;-<span class="st"> </span>xlist[[r]]</a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="kw">return</span>(me)</a>
<a class="sourceLine" id="cb12-7" title="7">}</a>
<a class="sourceLine" id="cb12-8" title="8"></a>
<a class="sourceLine" id="cb12-9" title="9">dat_metric &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Tr_F =</span> <span class="kw">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="op">$</span>F_tr), </a>
<a class="sourceLine" id="cb12-10" title="10">                         <span class="dt">Tr_B =</span> <span class="kw">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="op">$</span>B_tr),</a>
<a class="sourceLine" id="cb12-11" title="11">                         <span class="dt">err_alpha =</span><span class="kw">list2vec</span>(<span class="kw">lapply</span>(metricList, <span class="cf">function</span>(x) x<span class="op">$</span>alpha_norm1)),</a>
<a class="sourceLine" id="cb12-12" title="12">                         <span class="dt">err_beta =</span> <span class="kw">list2vec</span>(<span class="kw">lapply</span>(metricList, <span class="cf">function</span>(x) x<span class="op">$</span>beta_norm1)),</a>
<a class="sourceLine" id="cb12-13" title="13">                         <span class="dt">time =</span> <span class="kw">sapply</span>(metricList, <span class="cf">function</span>(x) x<span class="op">$</span>time),</a>
<a class="sourceLine" id="cb12-14" title="14">                         <span class="dt">Method =</span> <span class="kw">names</span>(metricList))</a>
<a class="sourceLine" id="cb12-15" title="15">dat_metric<span class="op">$</span>Method &lt;-<span class="st"> </span><span class="kw">factor</span>(dat_metric<span class="op">$</span>Method, <span class="dt">levels=</span>dat_metric<span class="op">$</span>Method)</a></code></pre></div>
<p>Plot the results for COAP and other methods, which suggests that COAP achieves better estimation accuracy for the quantiites of interest.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">library</span>(cowplot)</a>
<a class="sourceLine" id="cb13-2" title="2">p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span><span class="kw">subset</span>(dat_metric, <span class="op">!</span><span class="kw">is.na</span>(Tr_B)), <span class="kw">aes</span>(<span class="dt">x=</span> Method, <span class="dt">y=</span>Tr_B, <span class="dt">fill=</span>Method)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>(<span class="dt">base_size =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb13-3" title="3">p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span><span class="kw">subset</span>(dat_metric, <span class="op">!</span><span class="kw">is.na</span>(Tr_F)), <span class="kw">aes</span>(<span class="dt">x=</span> Method, <span class="dt">y=</span>Tr_F, <span class="dt">fill=</span>Method)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="ot">NULL</span>)<span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>(<span class="dt">base_size =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb13-4" title="4">p3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span><span class="kw">subset</span>(dat_metric, <span class="op">!</span><span class="kw">is.na</span>(err_alpha)), <span class="kw">aes</span>(<span class="dt">x=</span> Method, <span class="dt">y=</span>err_alpha, <span class="dt">fill=</span>Method)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="ot">NULL</span>)<span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>(<span class="dt">base_size =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb13-5" title="5">p4 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span><span class="kw">subset</span>(dat_metric, <span class="op">!</span><span class="kw">is.na</span>(err_beta)), <span class="kw">aes</span>(<span class="dt">x=</span> Method, <span class="dt">y=</span>err_beta, <span class="dt">fill=</span>Method)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="ot">NULL</span>)<span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>(<span class="dt">base_size =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb13-6" title="6"><span class="kw">plot_grid</span>(p1,p2,p3, p4, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="select-the-parameters" class="section level2">
<h2>Select the parameters</h2>
<p>We applied the singular value ratio based method to select the number of factors and the rank of coefficient matrix. The results showed that the SVR method has the potential to identify the true values.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"></a>
<a class="sourceLine" id="cb14-2" title="2">res1 &lt;-<span class="st"> </span><span class="kw">chooseParams</span>(X_count, Adj_sp, H, Z, <span class="dt">verbose=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="kw">print</span>(<span class="kw">c</span>(<span class="dt">q_true=</span>q, <span class="dt">q_est=</span>res1[<span class="st">&#39;hq&#39;</span>]))</a>
<a class="sourceLine" id="cb14-5" title="5"><span class="kw">print</span>(<span class="kw">c</span>(<span class="dt">r_true=</span>r, <span class="dt">r_est=</span>res1[<span class="st">&#39;hr&#39;</span>]))</a></code></pre></div>
<details>
<p><summary><strong>Session Info</strong></summary></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">sessionInfo</span>()</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">#&gt; R version 4.1.2 (2021-11-01)</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co">#&gt; Running under: Windows 10 x64 (build 22631)</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">#&gt; Matrix products: default</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co">#&gt; locale:</span></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="co">#&gt; [1] LC_COLLATE=C                              </span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.936   </span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.936</span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="co">#&gt; [4] LC_NUMERIC=C                              </span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.936    </span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-15" title="15"><span class="co">#&gt; attached base packages:</span></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></a>
<a class="sourceLine" id="cb15-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-18" title="18"><span class="co">#&gt; loaded via a namespace (and not attached):</span></a>
<a class="sourceLine" id="cb15-19" title="19"><span class="co">#&gt;  [1] digest_0.6.29   R6_2.5.1        jsonlite_1.8.0  magrittr_2.0.3 </span></a>
<a class="sourceLine" id="cb15-20" title="20"><span class="co">#&gt;  [5] evaluate_0.15   stringi_1.7.6   rlang_1.1.0     cli_3.2.0      </span></a>
<a class="sourceLine" id="cb15-21" title="21"><span class="co">#&gt;  [9] rstudioapi_0.13 jquerylib_0.1.4 bslib_0.3.1     rmarkdown_2.11 </span></a>
<a class="sourceLine" id="cb15-22" title="22"><span class="co">#&gt; [13] tools_4.1.2     stringr_1.4.0   xfun_0.29       yaml_2.3.6     </span></a>
<a class="sourceLine" id="cb15-23" title="23"><span class="co">#&gt; [17] fastmap_1.1.0   compiler_4.1.2  htmltools_0.5.2 knitr_1.37     </span></a>
<a class="sourceLine" id="cb15-24" title="24"><span class="co">#&gt; [21] sass_0.4.1</span></a></code></pre></div>
</details>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
